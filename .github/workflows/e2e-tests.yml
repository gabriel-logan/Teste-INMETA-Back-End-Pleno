name: E2E Tests with Mongo Replica Set

on:
  pull_request:
    branches: ["main"]
    paths:
      - "src/**"
      - "test/**"
      - ".github/workflows/e2e-tests.yml"
      - "yarn.lock"
      - "tsconfig.json"
      - "nest-cli.json"
  push:
    branches: ["main"]
    paths:
      - "src/**"
      - "test/**"
      - ".github/workflows/e2e-tests.yml"
      - "yarn.lock"
      - "tsconfig.json"
      - "nest-cli.json"

  workflow_dispatch:

jobs:
  e2e:
    runs-on: ubuntu-latest

    env:
      MONGODB_URI: mongodb://localhost:27017/test-db?replicaSet=rs0

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: yarn

      - name: Install dependencies
        run: yarn install

      - name: Start MongoDB with replica set
        run: |
          docker run -d --name mongo-rs \
            -p 27017:27017 \
            mongo:6.0 --replSet rs0

          echo "Waiting for MongoDB to start..."
          sleep 5

          echo "Initializing replica set..."
          docker exec mongo-rs mongosh --eval 'rs.initiate({_id: "rs0", members: [{ _id: 0, host: "localhost:27017" }]})'

          echo "Waiting for replica set to stabilize..."
          sleep 5

      - name: Run E2E tests
        run: yarn test:e2e
